# Example: Using ALB module with web servers

# Security group for ALB
module "alb_security_group" {
  source = "../../../modules/security-groups"

  name        = "${var.project_name}-alb-sg"
  description = "Security group for Application Load Balancer"
  vpc_id      = module.vpc.vpc_id

  ingress_rules = [
    {
      from_port   = 80
      to_port     = 80
      protocol    = "tcp"
      cidr_ipv4   = "0.0.0.0/0"
      description = "HTTP from internet"
    },
    {
      from_port   = 443
      to_port     = 443
      protocol    = "tcp"
      cidr_ipv4   = "0.0.0.0/0"
      description = "HTTPS from internet"
    }
  ]

  tags = local.common_tags
}

# Application Load Balancer
module "alb" {
  source = "../../../modules/alb"

  name               = "${var.project_name}-alb"
  internal           = false
  vpc_id             = module.vpc.vpc_id
  subnet_ids         = module.vpc.public_subnet_ids
  security_group_ids = [module.alb_security_group.id]

  enable_deletion_protection = var.alb_deletion_protection
  enable_http2              = true
  
  # Target groups configuration
  target_groups = {
    web = {
      port                 = 80
      protocol             = "HTTP"
      deregistration_delay = 30
      enable_stickiness    = true
      stickiness_duration  = 3600
      health_check = {
        enabled             = true
        healthy_threshold   = 2
        unhealthy_threshold = 2
        timeout             = 5
        interval            = 30
        path                = "/health"
        matcher             = "200"
        protocol            = "HTTP"
      }
    }
    api = {
      port                 = 8080
      protocol             = "HTTP"
      deregistration_delay = 10
      enable_stickiness    = false
      stickiness_duration  = 0
      health_check = {
        enabled             = true
        healthy_threshold   = 2
        unhealthy_threshold = 3
        timeout             = 5
        interval            = 30
        path                = "/api/health"
        matcher             = "200,204"
        protocol            = "HTTP"
      }
    }
  }

  # Attach instances to target groups
  target_attachments = {
    web1 = {
      target_group_key = "web"
      instance_id      = module.web_servers.instance_ids[0]
      port             = 80
    }
    # Add more attachments as needed
  }

  # Listeners
  create_http_listener     = true
  create_https_listener    = false  # Set to true when you have SSL cert
  redirect_http_to_https   = false  # Enable when HTTPS is configured
  default_target_group_key = "web"

  # Path-based routing rules
  listener_rules = {
    api_route = {
      priority         = 100
      target_group_key = "api"
      path_patterns    = ["/api/*"]
      host_headers     = null
    }
  }

  tags = merge(local.common_tags, {
    Purpose = "Application Load Balancer"
  })
}

# Output ALB DNS
output "alb_dns_name" {
  description = "DNS name of the Application Load Balancer"
  value       = module.alb.alb_dns_name
}
