# Enterprise-Level Change Tracking and Audit Configuration

# 1. Enhanced tagging for change tracking
locals {
  common_tags = {
    Project      = var.project_name
    Environment  = var.environment
    Owner        = var.resource_owner  # Who owns this resource
    ManagedBy    = "Terraform"
    Repository   = "internal-poc/Terraform-standardisation"
    LastModified = formatdate("YYYY-MM-DD", timestamp())
    CostCenter   = var.cost_center
    Compliance   = var.compliance_level
  }

  # Resource-specific tags with change tracking
  resource_tags = {
    # Git information (set via CI/CD)
    GitCommitSHA    = var.git_commit_sha
    GitBranch       = var.git_branch
    GitAuthor       = var.git_author
    DeployedBy      = var.deployed_by
    DeploymentTime  = timestamp()
    TerraformVersion = var.terraform_version
  }
}

# 2. Variables for change tracking
variable "resource_owner" {
  description = "Email or username of resource owner"
  type        = string
  default     = "charan@company.com"
}

variable "cost_center" {
  description = "Cost center for billing"
  type        = string
  default     = "Engineering"
}

variable "compliance_level" {
  description = "Compliance level (PCI, HIPAA, SOC2, etc.)"
  type        = string
  default     = "Internal"
}

variable "git_commit_sha" {
  description = "Git commit SHA (set by CI/CD)"
  type        = string
  default     = "local"
}

variable "git_branch" {
  description = "Git branch name"
  type        = string
  default     = "main"
}

variable "git_author" {
  description = "Git commit author"
  type        = string
  default     = "unknown"
}

variable "deployed_by" {
  description = "Who triggered the deployment"
  type        = string
  default     = "manual"
}

variable "terraform_version" {
  description = "Terraform version used"
  type        = string
  default     = "1.7.0"
}

# 3. CloudTrail for AWS API audit logging
resource "aws_cloudtrail" "main" {
  count = var.enable_cloudtrail ? 1 : 0

  name                          = "${var.project_name}-cloudtrail"
  s3_bucket_name               = aws_s3_bucket.cloudtrail_logs[0].id
  include_global_service_events = true
  is_multi_region_trail        = true
  enable_log_file_validation   = true

  event_selector {
    read_write_type           = "All"
    include_management_events = true

    data_resource {
      type   = "AWS::S3::Object"
      values = ["arn:aws:s3:::*/"]
    }
  }

  tags = merge(local.common_tags, {
    Purpose = "Audit Logging"
  })
}

# S3 bucket for CloudTrail logs
resource "aws_s3_bucket" "cloudtrail_logs" {
  count  = var.enable_cloudtrail ? 1 : 0
  bucket = "${var.project_name}-cloudtrail-logs-${data.aws_caller_identity.current.account_id}"

  tags = merge(local.common_tags, {
    Purpose = "CloudTrail Logs"
  })
}

resource "aws_s3_bucket_versioning" "cloudtrail_logs" {
  count  = var.enable_cloudtrail ? 1 : 0
  bucket = aws_s3_bucket.cloudtrail_logs[0].id

  versioning_configuration {
    status = "Enabled"
  }
}

resource "aws_s3_bucket_lifecycle_configuration" "cloudtrail_logs" {
  count  = var.enable_cloudtrail ? 1 : 0
  bucket = aws_s3_bucket.cloudtrail_logs[0].id

  rule {
    id     = "archive-old-logs"
    status = "Enabled"

    transition {
      days          = 90
      storage_class = "GLACIER"
    }

    expiration {
      days = 365
    }
  }
}

# 4. SNS topic for infrastructure change notifications
resource "aws_sns_topic" "infrastructure_changes" {
  count = var.enable_change_notifications ? 1 : 0
  name  = "${var.project_name}-infra-changes"

  tags = merge(local.common_tags, {
    Purpose = "Change Notifications"
  })
}

resource "aws_sns_topic_subscription" "infrastructure_changes_email" {
  count     = var.enable_change_notifications && var.notification_email != "" ? 1 : 0
  topic_arn = aws_sns_topic.infrastructure_changes[0].arn
  protocol  = "email"
  endpoint  = var.notification_email
}

# 5. EventBridge rule for EC2 changes
resource "aws_cloudwatch_event_rule" "ec2_changes" {
  count       = var.enable_change_notifications ? 1 : 0
  name        = "${var.project_name}-ec2-changes"
  description = "Capture EC2 instance state changes"

  event_pattern = jsonencode({
    source      = ["aws.ec2"]
    detail-type = ["EC2 Instance State-change Notification"]
  })

  tags = local.common_tags
}

resource "aws_cloudwatch_event_target" "ec2_changes_sns" {
  count     = var.enable_change_notifications ? 1 : 0
  rule      = aws_cloudwatch_event_rule.ec2_changes[0].name
  target_id = "SendToSNS"
  arn       = aws_sns_topic.infrastructure_changes[0].arn
}

# 6. Data source for current identity
data "aws_caller_identity" "current" {}

# 7. Variables for audit features
variable "enable_cloudtrail" {
  description = "Enable CloudTrail for audit logging"
  type        = bool
  default     = true
}

variable "enable_change_notifications" {
  description = "Enable SNS notifications for infrastructure changes"
  type        = bool
  default     = true
}

variable "notification_email" {
  description = "Email address for change notifications"
  type        = string
  default     = "devops@company.com"
}
